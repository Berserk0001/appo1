import undici from"undici";import lodash from"lodash";import{generateRandomIP,randomUserAgent}from"./utils.js";import{copyHeaders as copyHdrs}from"./copyHeaders.js";import{compressImg as applyCompression}from"./compress.js";import{bypass as performBypass}from"./bypass.js";import{redirect as handleRedirect}from"./redirect.js";import{shouldCompress as checkCompression}from"./shouldCompress.js";const viaHeaders=["1.1 example-proxy-service.com (ExampleProxy/1.0)","1.0 another-proxy.net (Proxy/2.0)","1.1 different-proxy-system.org (DifferentProxy/3.1)","1.1 some-proxy.com (GenericProxy/4.0)"];function randomVia(){const e=Math.floor(Math.random()*viaHeaders.length);return viaHeaders[e]}export async function processRequest(r,o){let e=r.query.url;if(!e){const t=generateRandomIP();const n=randomUserAgent();const d={...lodash.pick(r.headers,["cookie","dnt","referer"]),"x-forwarded-for":t,"user-agent":n,via:randomVia()};Object.entries(d).forEach(([e,r])=>o.header(e,r));return o.send(`bandwidth-hero-proxy`)}r.params.url=decodeURIComponent(e);r.params.webp=!r.query.jpeg;r.params.grayscale=r.query.bw!=="0";r.params.quality=parseInt(r.query.l,10)||40;const s=generateRandomIP();const a=randomUserAgent();try{const i=await undici.request(r.params.url,{headers:{...lodash.pick(r.headers,["cookie","dnt","referer"]),"x-forwarded-for":s,"user-agent":a,via:randomVia()},maxRedirections:5});if(i.statusCode>=400){return handleRedirect(r,o)}if(i.statusCode>=300&&i.headers.location){return handleRedirect(r,o)}copyHdrs(i,o);o.header("content-encoding","identity");r.params.originType=i.headers["content-type"]||"";r.params.originSize=parseInt(i.headers["content-length"],10)||0;const p={body:i.body};if(checkCompression(r)){return applyCompression(r,o,p)}else{return performBypass(r,o,i.body)}}catch(e){return handleRedirect(r,o)}}
